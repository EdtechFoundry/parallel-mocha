#!/usr/bin/env node

const program = require('commander');
const fs = require('fs');
const glob = require('glob');
const Runner = require('../lib/runner');
const async = require('async');

program
    .version(JSON.parse(fs.readFileSync(__dirname + '/../package.json', 'utf8')).version)
    .usage('[options] <files...>')
    .option('-p, --processes <n>', 'Set number of processes', parseInt)
    .option('-t, --timeout <n>', 'Timeout between testes', parseInt)
    .option('-s, --slow <n>', 'Wait for slow tests', parseInt)
    .parse(process.argv);

// TODO: how can i make sure workers is integer?
let processes = program.processes || 20;
let timeout = program.timeout || 10000;
let slow = program.slow || 2000;
let files = program.args;

let resolveFilesQueue = files.map(
    file=>(cb)=> {
        glob(file, cb)
    }
);

async.parallel(resolveFilesQueue, (err, files)=> {
    if (err) {
        throw err;
    }

    var runner = new Runner(files, {
        processes: files.length,
        timeout: timeout,
        slow: slow
    });

    runner.run((error) => {
        if (error) {
            console.log('==== Failed: %s', error.message);
        } else {
            console.log('==== Pass!');
        }
    });
});



